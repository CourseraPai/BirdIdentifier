---
title: "Bird Identification"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(taxize)
library(cld2)
library(cld3)
library(magrittr)
library(tidyverse)
library(tidyr)
library(tesseract)


filenames<-fs::dir_ls("F:/Data/BirdIdentifier/birds")

magick::image_read(filenames[1])

crop_bird <- function(filename){
  image <- magick::image_read(filename)
  
  height <- magick::image_info(image)$height
  
  # crop the top of the image
  image <- magick::image_crop(image, 
                     paste0("+0+",round(0.75*height))) %>%
    # convert the image to black and white
    magick::image_convert(type = "grayscale") %>%
    # increase brightness
    magick::image_modulate(brightness = 120) %>%
    magick::image_enhance() %>%
    magick::image_median() %>%
    magick::image_contrast() 
  
  # we'll need the filename later
  attr(image, "filename") <- filename
  
  return(image)
}

crop_bird(filenames[1])


get_names <- function(image){
  filename <- attr(image, "filename")
  ocr_options <- list(tessedit_pageseg_mode = 1)
   
  text <- magick::image_ocr(image, options = ocr_options)
  text <- stringr::str_split(text, "\n", simplify = TRUE)
  text <- stringr::str_remove_all(text, "[0-9]")
  text <- stringr::str_remove_all(text, "[:punct:]")
  text <- trimws(text)
  text <- stringr::str_remove_all(text, "~")
  text <- text[text != ""]
  text <- tolower(text)
  
  # remove one letter words
  # https://stackoverflow.com/questions/31203843/r-find-and-remove-all-one-to-two-letter-words
  text <- stringr::str_remove_all(text, " *\\b[[:alpha:]]{1,2}\\b *")
  text <- text[text != ""]
  
  # keep only the words that are recognized as either Latin
  # or English by cld2 or cld3
  if(length(text) > 0){
    results <- tibble::tibble(text = text,
                 cld2 = cld2::detect_language(text),
                 cld3 = cld3::detect_language(text),
                 filename = filename)
  
  results[results $cld2 %in% c("la", "en") |
          results$cld3 %in% c("la", "en"),]
  }else{
    return(NULL)
  }
  
  
}
filenames[1]

(results2 <- filenames[1] %>%
  crop_bird() %>%
  get_names())


latin <- results2$text[results2$cld2 == "la"|
                         results2$cld3 == "la"]
taxize::gnr_resolve(latin,
  best_match_only = TRUE)


bird_names <- purrr::map(filenames, crop_bird) %>%  purrr::map_df(get_names)


safe_resolve <- function(text){
  
  results <- taxize::gnr_resolve(text,
                                 best_match_only = TRUE)
  
  if(nrow(results) == 0){
    list(NULL)
  }else{
    list(results)
  }
}

bird_names <- dplyr::group_by(bird_names, text) %>%
  dplyr::mutate(gnr = ifelse(cld2 == "la" | cld3 == "la",
                             safe_resolve(text),
                             list(NULL)))


bird_names



```

